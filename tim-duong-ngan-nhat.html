<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Giải thuật AKT</title>
    <link rel="stylesheet" href="./bootstrap.min.css">
    <style>
    html,body{
        height: 100%;
    }
    canvas{
        width:calc(100% - 500px);
        float:left;
        height:100%;
        background: #000;
    }
    .wrap-table{
        float:left;
        width:470px;
        padding:15px;
        text-align: left;
    }
    </style>
</head>
<body>
<canvas id="app"></canvas>
<div class="wrap-table">
    <div class="row">
        <div class="col-xs-6">
            <div class="form-group">
                <label>From</label>
                <input id="from" type="text" class="form-control" />
            </div>
        </div>
        <div class="col-xs-6">
            <div class="form-group">
                <label>To</label>
                <input id="to" type="text" class="form-control" />
            </div>
        </div>
    </div>
    <input class="btn btn-primary pull-right" style="margin-bottom:20px" type="button" value="Add" id="submit">
    
   
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>
                    Position (from)
                </th>
                <th>
                    Position (to)
                </th>
                <th>
                    Distance
                </th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <div class="row">
        <div class="col-xs-6">
            <div class="form-group">
                <label>Start</label>
                <input id="start" type="text" class="form-control" />
            </div>
        </div>
        <div class="col-xs-6">
            <div class="form-group">
                <label>End</label>
                <input id="end" type="text" class="form-control" />
            </div>
        </div>
    </div>
    <input class="btn btn-primary pull-right" style="margin-bottom:20px" type="button" value="Find" id="find">
    
    
</div>

<script src="./jquery-3.3.1.min.js"></script>
<script src="./underscore-min.js"></script>
<script>

(function(){
    var dataTable = [];
    var position = [];
    var count = 0;

    // init app
    var canvas = document.getElementById("app"),
        ctx = canvas.getContext("2d");

    canvas.width = $("canvas").outerWidth();
    canvas.height = $("canvas").outerHeight();


    // click position
    $("canvas").on("click", function (evt) {
        var positionElement = getMousePos(canvas , evt);

        // fill rect
        ctx.fillStyle = "#fff";
        ctx.fillRect(positionElement.x -7.5 , positionElement.y - 22, 30, 30);
        
        // fill text
        ctx.font = "20px Georgia";
        ctx.fillStyle = "#000";
        ctx.fillText( count , positionElement.x, positionElement.y);
        
        // save position
        position.push({
            x: positionElement.x,
            y: positionElement.y,
            name: count
        });

        // next postion
        count++;
    });

    // submit form
    $("#submit").on("click" , function(){
        // id from and to
        var from  = $("#from").val();
        var to = $("#to").val();

        // position from and to
        var fromX = position[from].x;
        var fromY = position[from].y;
        var toX = position[to].x;
        var toY = position[to].y;
        var distance = distance2Point(fromX, fromY, toX, toY) ;

        // append data to table
        $("table tbody").append(`
            <tr>
                <td>${ from }</td>
                <td>${ to }</td>
                <td>${ distance }</td>
            </tr>
        `);
        dataTable.push({
            from: from,
            to : to,
            distance : distance
        });

        // stroke line from A to B
        ctx.beginPath();
        ctx.moveTo(fromX, fromY);
        ctx.lineTo(toX, toY);
        ctx.strokeStyle = "#fff";
        ctx.stroke();
    });

    // find best way
    $("#find").on("click" , function(){
        AKT(dataTable);
    });

}());
function getMousePos(canvas, evt) {
    var rect = canvas.getBoundingClientRect();
    return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
    };
}

function distance2Point(x1 , y1 , x2 , y2){
    var a = x1 - x2;
    var b = y1 - y2;

    return c = Math.sqrt(a * a + b * b).toFixed(2);
}

function AKT(dataTable){
    var start = $("#start").val();
    window.start = $("#start").val();
    var end = $("#end").val();
    window.end = $("#end").val();

    // filter list start
    var result = _.filter(dataTable, function (value) {
        return value.from == start;
    });

    console.log(result);

    console.log(Fn(dataTable , result  ) );
}
window.testArr = [];
function Fn(dataTable , result ){
    var returnValue = {};
    var arrayResult = [];

    var findAResult = false;
    // each child
    _.each(result , function(child){
        // flag
        if(findAResult){
            return false;
        }
        // check diem con này có phải điểm cuối hay dích k
        var checkChildEnd = _.filter(dataTable, function (value) {
            return value.from == child.to;
        });
        console.log(child.to);

        /*
            nếu đích là giá trị cần tìm
            trả về f(S) của nó
         */
        if(child.to  == window.end){
            arrayResult.push({
                sum: +child.distance,
                way: [child.from, child.to]
            })
            findAResult = true;
        }
        /* 
            nếu không phải là đích trả về giá trị lỗi
        */
        else if (checkChildEnd.length == 0) {
            arrayResult.push({sum: 0, way: []})
        }else{
            /*
                nếu còn child thì tìm xuống típ
            */
            var children = _.filter(dataTable, function (value) {
                return value.from == child.to;
            });
            var newItem = Fn(dataTable, children);

            // nếu cấp con trả về giá trị
            if (newItem) {
                arrayResult.push({
                    sum: newItem.sum + (+child.distance),
                    way: [child.from].concat(newItem.way)
                })
            } else {
                arrayResult.push({sum: 0,way: []});
            }
        }      

    });

    returnValue = _.sortBy(arrayResult, "sum")[0];
    return returnValue;
}
</script>
</body>
</html>